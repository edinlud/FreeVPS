name: Convert all MKV to TS (rclone + tsMuxeR)

on:
  workflow_dispatch:

jobs:
  mux-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y rclone wget
          wget https://github.com/justdan96/tsMuxer/releases/download/nightly/tsMuxer-CLI.Linux.tar.gz
          tar -xzf tsMuxer-CLI.Linux.tar.gz
          sudo mv tsMuxer/tsMuxeR /usr/local/bin/

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          rclone listremotes

      - name: List MKV files in SOURCE_REMOTE
        run: |
          echo "Files in ${{ vars.SOURCE_REMOTE }}:"
          rclone lsf ${{ vars.SOURCE_REMOTE }} --include "*.mkv"

      - name: Convert all MKV to TS
        run: |
          FILES=$(rclone lsf ${{ vars.SOURCE_REMOTE }} --include "*.mkv")
          for f in $FILES; do
            echo "Processing $f ..."
            SRC="${{ vars.SOURCE_REMOTE }}$f"
